<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Women Zone | MultiZone Admin</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-flex {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .resource-list {
            margin-top: 2rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .resource-item {
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
    </style>
</head>

<body>

    <script>
        if (!localStorage.getItem("isAdmin")) {
            window.location.href = "admin-login.html";
        }
    </script>

    <nav class="scrolled">
        <a href="admin-dashboard.html" class="logo">MultiZone Admin</a>
        <div class="nav-links">
            <a href="admin-dashboard.html">Dashboard</a>
            <button class="btn btn-glass" onclick="logoutAdmin()">Sign Out</button>
        </div>
    </nav>

    <main class="dashboard-container">
        <header style="margin-bottom: 3rem;">
            <h1>Women Zone Manager</h1>
            <p style="color: var(--text-muted);">Publish new government schemes and emergency helplines.</p>
        </header>

        <div class="tabs">
            <button class="btn btn-glass tab-btn active" onclick="switchTab('schemes', this)">Government
                Schemes</button>
            <button class="btn btn-glass tab-btn" onclick="switchTab('helplines', this)">Emergency Helplines</button>
        </div>

        <div id="schemesSection" class="admin-flex">
            <div class="glass" style="padding: 2rem;">
                <h3>Add New Scheme</h3>
                <div class="form-group">
                    <label>Scheme Name</label>
                    <input type="text" id="schemeName" placeholder="e.g. Ladli Laxmi Yojan">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="schemeDesc" rows="3" placeholder="Explain the benefits and eligibility..."></textarea>
                </div>
                <div class="form-group">
                    <label>Apply Link (URL)</label>
                    <input type="text" id="schemeLink" placeholder="https://government.in/apply">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveScheme()">Publish Scheme</button>
            </div>

            <div class="resource-list" id="schemesList">
                <!-- Schemes will be loaded here -->
            </div>
        </div>

        <div id="helplinesSection" class="admin-flex" style="display: none;">
            <div class="glass" style="padding: 2rem;">
                <h3>Add New Helpline</h3>
                <div class="form-group">
                    <label>Organization Name</label>
                    <input type="text" id="helpName" placeholder="e.g. Women Power Line">
                </div>
                <div class="form-group">
                    <label>Helpline Number</label>
                    <input type="text" id="helpNumber" placeholder="e.g. 1090">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="helpCategory">
                        <option value="Emergency">Emergency</option>
                        <option value="Legal Aid">Legal Aid</option>
                        <option value="Health">Health</option>
                        <option value="Counseling">Counseling</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveHelpline()">Save Helpline</button>
            </div>

            <div class="resource-list" id="helplinesList">
                <!-- Helplines will be loaded here -->
            </div>
        </div>
    </main>

    <script type="module">
        import { addWomenScheme, getWomenSchemes, addHelpline, getHelplines, deleteItem } from "../assets/js/db.js";

        // Tab Handling
        const schemeBtn = document.getElementById('schemeBtn');
        const helpBtn = document.getElementById('helpBtn');
        const schemesSection = document.getElementById('schemesSection');
        const helplinesSection = document.getElementById('helplinesSection');

        window.switchTab = function (tab, btn) {
            console.log("Switching to tab:", tab);
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            if (tab === 'schemes') {
                schemesSection.style.display = 'grid';
                helplinesSection.style.display = 'none';
                loadSchemes();
            } else {
                schemesSection.style.display = 'none';
                helplinesSection.style.display = 'grid';
                loadHelplines();
            }
        };

        // Add Listeners (Extra safety)
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Manager Ready");
        });

        window.saveScheme = async function () {
            const name = document.getElementById('schemeName').value;
            const desc = document.getElementById('schemeDesc').value;
            const link = document.getElementById('schemeLink').value;

            if (!name || !desc) {
                alert("Please fill required fields (Name and Description)");
                return;
            }

            try {
                const res = await addWomenScheme({ name, desc, link, createdAt: new Date().toISOString() });
                if (res) {
                    alert("✅ Scheme published successfully!");
                    document.getElementById('schemeName').value = '';
                    document.getElementById('schemeDesc').value = '';
                    document.getElementById('schemeLink').value = '';
                    loadSchemes();
                }
            } catch (e) {
                console.error(e);
                alert("❌ Error saving scheme: " + e.message);
            }
        };

        window.saveHelpline = async function () {
            const name = document.getElementById('helpName').value;
            const number = document.getElementById('helpNumber').value;
            const category = document.getElementById('helpCategory').value;

            if (!name || !number) {
                alert("Please fill required fields (Name and Number)");
                return;
            }

            try {
                const res = await addHelpline({ name, number, category, createdAt: new Date().toISOString() });
                if (res) {
                    alert("✅ Helpline saved successfully!");
                    document.getElementById('helpName').value = '';
                    document.getElementById('helpNumber').value = '';
                    loadHelplines();
                }
            } catch (e) {
                console.error(e);
                alert("❌ Error saving helpline: " + e.message);
            }
        };

        async function loadSchemes() {
            const list = document.getElementById('schemesList');
            list.innerHTML = '<p style="padding:1rem;">Loading schemes...</p>';
            try {
                const schemes = await getWomenSchemes();
                list.innerHTML = '';
                if (schemes.length === 0) {
                    list.innerHTML = '<p style="padding:2rem; text-align:center; color:var(--text-muted);">No schemes found yet.</p>';
                    return;
                }
                schemes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'resource-item glass';
                    div.innerHTML = `
                        <div>
                            <h4 style="color:var(--primary-light)">${s.name}</h4>
                            <p style="font-size:0.85rem; color:var(--text-muted)">${s.desc.substring(0, 60)}${s.desc.length > 60 ? '...' : ''}</p>
                        </div>
                        <button class="btn" style="color:#ef4444" onclick="handleDelete('women_schemes', '${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<p style="color:#ef4444; padding:1rem;">Error loading schemes.</p>';
            }
        }

        async function loadHelplines() {
            const list = document.getElementById('helplinesList');
            list.innerHTML = '<p style="padding:1rem;">Loading helplines...</p>';
            try {
                const helplines = await getHelplines();
                list.innerHTML = '';
                if (helplines.length === 0) {
                    list.innerHTML = '<p style="padding:2rem; text-align:center; color:var(--text-muted);">No helplines found yet.</p>';
                    return;
                }
                helplines.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'resource-item glass';
                    div.innerHTML = `
                        <div>
                            <h4 style="color:var(--accent)">${h.name}</h4>
                            <p>${h.number} (${h.category})</p>
                        </div>
                        <button class="btn" style="color:#ef4444" onclick="handleDelete('helplines', '${h.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                list.innerHTML = '<p style="color:#ef4444; padding:1rem;">Error loading helplines.</p>';
            }
        }

        window.handleDelete = async function (col, id) {
            if (confirm("Are you sure you want to delete this?")) {
                try {
                    await deleteItem(col, id);
                    if (col === 'women_schemes') loadSchemes();
                    else loadHelplines();
                } catch (e) {
                    alert("Error deleting item.");
                }
            }
        };

        window.logoutAdmin = function () {
            localStorage.removeItem("isAdmin");
            window.location.href = "admin-login.html";
        };

        // Initial load
        loadSchemes();
    </script>
</body>

</html>